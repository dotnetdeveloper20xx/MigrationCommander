@page "/settings"
@using MigrationCommander.Core.Interfaces
@inject IConfiguration Configuration

<PageTitle>Settings - MigrationCommander</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Settings</h1>
    </div>

    @if (_saving)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Saving...</span>
            </div>
            Saving settings...
        </div>
    }
    else if (_saved)
    {
        <div class="alert alert-success alert-dismissible fade show">
            Settings saved successfully!
            <button type="button" class="btn-close" @onclick="() => _saved = false"></button>
        </div>
    }

    <div class="row g-4">
        <!-- General Settings -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-gear me-2" viewBox="0 0 16 16">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
                            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
                        </svg>
                        General Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Default Page Size</label>
                        <select class="form-select" @bind="_settings.DefaultPageSize">
                            <option value="10">10 items</option>
                            <option value="25">25 items</option>
                            <option value="50">50 items</option>
                            <option value="100">100 items</option>
                        </select>
                        <div class="form-text">Number of items to show per page in lists.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Date Format</label>
                        <select class="form-select" @bind="_settings.DateFormat">
                            <option value="yyyy-MM-dd">2026-01-19 (ISO)</option>
                            <option value="MM/dd/yyyy">01/19/2026 (US)</option>
                            <option value="dd/MM/yyyy">19/01/2026 (EU)</option>
                            <option value="dd-MMM-yyyy">19-Jan-2026</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Time Zone</label>
                        <select class="form-select" @bind="_settings.TimeZone">
                            <option value="UTC">UTC</option>
                            <option value="Local">Local Time</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Migration Settings -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-database-gear me-2" viewBox="0 0 16 16">
                            <path d="M12.096 6.223A5 5 0 0 0 13 5.698V7c0 .289-.213.654-.753 1.007a4.5 4.5 0 0 1 1.753.25V4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16c.536 0 1.058-.034 1.555-.097a4.5 4.5 0 0 1-.813-.927Q8.378 15 8 15c-1.464 0-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13h.027a4.6 4.6 0 0 1 0-1H8c-1.464 0-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10q.393 0 .774-.024a4.5 4.5 0 0 1 1.102-1.132C9.298 8.944 8.666 9 8 9c-1.464 0-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777M3 4c0-.374.356-.875 1.318-1.313C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4"/>
                            <path d="M11.886 9.46c.18-.613 1.048-.613 1.229 0l.043.148a.64.64 0 0 0 .921.382l.136-.074c.561-.306 1.175.308.87.869l-.075.136a.64.64 0 0 0 .382.92l.149.045c.612.18.612 1.048 0 1.229l-.15.043a.64.64 0 0 0-.38.921l.074.136c.305.561-.309 1.175-.87.87l-.136-.075a.64.64 0 0 0-.92.382l-.045.149c-.18.612-1.048.612-1.229 0l-.043-.15a.64.64 0 0 0-.921-.38l-.136.074c-.561.305-1.175-.309-.87-.87l.075-.136a.64.64 0 0 0-.382-.92l-.148-.045c-.613-.18-.613-1.048 0-1.229l.148-.043a.64.64 0 0 0 .382-.921l-.074-.136c-.306-.561.308-1.175.869-.87l.136.075a.64.64 0 0 0 .92-.382zM14 12.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0"/>
                        </svg>
                        Migration Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoBackup" @bind="_settings.AutoBackupBeforeMigration">
                            <label class="form-check-label" for="autoBackup">Auto-backup before migration</label>
                        </div>
                        <div class="form-text">Create a database backup before applying migrations.</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="requireConfirm" @bind="_settings.RequireConfirmationForProduction">
                            <label class="form-check-label" for="requireConfirm">Require confirmation for production</label>
                        </div>
                        <div class="form-text">Always require manual confirmation for production environments.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Migration Timeout (seconds)</label>
                        <input type="number" class="form-control" @bind="_settings.MigrationTimeoutSeconds" min="30" max="3600" />
                        <div class="form-text">Maximum time allowed for a single migration to complete.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Transaction Mode</label>
                        <select class="form-select" @bind="_settings.TransactionMode">
                            <option value="PerMigration">Per Migration (Recommended)</option>
                            <option value="AllMigrations">All Migrations</option>
                            <option value="None">No Transaction</option>
                        </select>
                        <div class="form-text">How to wrap migrations in database transactions.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-bell me-2" viewBox="0 0 16 16">
                            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2M8 1.918l-.797.161A4 4 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4 4 0 0 0-3.203-3.92zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5 5 0 0 1 13 6c0 .88.32 4.2 1.22 6"/>
                        </svg>
                        Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" @bind="_settings.EmailNotifications">
                            <label class="form-check-label" for="emailNotifications">Email notifications</label>
                        </div>
                        <div class="form-text">Receive email notifications for migration events.</div>
                    </div>

                    @if (_settings.EmailNotifications)
                    {
                        <div class="mb-3">
                            <label class="form-label">Notification Email</label>
                            <input type="email" class="form-control" @bind="_settings.NotificationEmail" placeholder="admin@example.com" />
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">Notify On</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifySuccess" @bind="_settings.NotifyOnSuccess">
                            <label class="form-check-label" for="notifySuccess">Successful migrations</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyFailure" @bind="_settings.NotifyOnFailure">
                            <label class="form-check-label" for="notifyFailure">Failed migrations</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyRollback" @bind="_settings.NotifyOnRollback">
                            <label class="form-check-label" for="notifyRollback">Rollbacks</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Settings -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-journal-text me-2" viewBox="0 0 16 16">
                            <path d="M5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                            <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2"/>
                            <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1z"/>
                        </svg>
                        Audit & Logging
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableAudit" @bind="_settings.EnableAuditLogging">
                            <label class="form-check-label" for="enableAudit">Enable audit logging</label>
                        </div>
                        <div class="form-text">Log all migration operations for compliance.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Audit Retention (days)</label>
                        <input type="number" class="form-control" @bind="_settings.AuditRetentionDays" min="7" max="365" />
                        <div class="form-text">How long to keep audit logs before automatic cleanup.</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="logSql" @bind="_settings.LogExecutedSql">
                            <label class="form-check-label" for="logSql">Log executed SQL</label>
                        </div>
                        <div class="form-text">Store the actual SQL executed in audit logs.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="mt-4">
        <button class="btn btn-primary" @onclick="SaveSettings" disabled="@_saving">
            @if (_saving)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            }
            Save Settings
        </button>
        <button class="btn btn-outline-secondary ms-2" @onclick="ResetToDefaults">Reset to Defaults</button>
    </div>

    <!-- Application Info -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Application Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Version:</strong><br />
                    <span class="text-muted">1.0.0</span>
                </div>
                <div class="col-md-4">
                    <strong>.NET Version:</strong><br />
                    <span class="text-muted">@Environment.Version</span>
                </div>
                <div class="col-md-4">
                    <strong>Database Path:</strong><br />
                    <span class="text-muted font-monospace small">@_databasePath</span>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool _saving = false;
    private bool _saved = false;
    private string _databasePath = "";

    private AppSettings _settings = new();

    protected override void OnInitialized()
    {
        _databasePath = Configuration["MigrationCommander:DatabasePath"] ?? "Default Location";
        LoadSettings();
    }

    private void LoadSettings()
    {
        // Load settings from configuration or use defaults
        _settings = new AppSettings
        {
            DefaultPageSize = 25,
            DateFormat = "yyyy-MM-dd",
            TimeZone = "UTC",
            AutoBackupBeforeMigration = false,
            RequireConfirmationForProduction = true,
            MigrationTimeoutSeconds = 300,
            TransactionMode = "PerMigration",
            EmailNotifications = false,
            NotificationEmail = "",
            NotifyOnSuccess = false,
            NotifyOnFailure = true,
            NotifyOnRollback = true,
            EnableAuditLogging = true,
            AuditRetentionDays = 90,
            LogExecutedSql = true
        };
    }

    private async Task SaveSettings()
    {
        _saving = true;
        _saved = false;
        StateHasChanged();

        try
        {
            // Simulate saving settings
            await Task.Delay(500);

            // In a real implementation, save to configuration or database
            // await _settingsService.SaveSettingsAsync(_settings);

            _saved = true;
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private void ResetToDefaults()
    {
        LoadSettings();
    }

    private class AppSettings
    {
        public int DefaultPageSize { get; set; }
        public string DateFormat { get; set; } = "";
        public string TimeZone { get; set; } = "";
        public bool AutoBackupBeforeMigration { get; set; }
        public bool RequireConfirmationForProduction { get; set; }
        public int MigrationTimeoutSeconds { get; set; }
        public string TransactionMode { get; set; } = "";
        public bool EmailNotifications { get; set; }
        public string NotificationEmail { get; set; } = "";
        public bool NotifyOnSuccess { get; set; }
        public bool NotifyOnFailure { get; set; }
        public bool NotifyOnRollback { get; set; }
        public bool EnableAuditLogging { get; set; }
        public int AuditRetentionDays { get; set; }
        public bool LogExecutedSql { get; set; }
    }
}
